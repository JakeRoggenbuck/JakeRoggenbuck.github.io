{{- printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\"?>" | safeHTML -}}
<urlset
  xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
  xmlns:image="http://www.google.com/schemas/sitemap-image/1.1">

{{- range .Sites }}
  {{- /* Ensure BaseURL has a scheme */ -}}
  {{- $baseURL := $.Site.BaseURL -}}
  {{- if not (hasPrefix $baseURL "http") -}}
    {{- if hasPrefix $baseURL "//" -}}
      {{- $baseURL = printf "https:%s" $baseURL -}}
    {{- else -}}
      {{- $baseURL = printf "https://%s" (strings.TrimPrefix "/" $baseURL) -}}
    {{- end -}}
  {{- end -}}
  {{- $baseURL = strings.TrimSuffix "/" $baseURL -}}

  {{- /* Include home page first */ -}}
  {{- with .Home }}
  {{- $relPath := strings.TrimPrefix "/" .RelPermalink -}}
  {{- $url := cond (eq $relPath "") $baseURL (printf "%s/%s" $baseURL $relPath) -}}
  <url>
    <loc>{{ $url }}</loc>

    {{- with .Lastmod }}
    <lastmod>{{ .Format "2006-01-02T15:04:05-07:00" }}</lastmod>
    {{- end }}

    {{- /* Add images from markdown front matter + page bundles */ -}}
    {{- $resources := .Resources.ByType "image" -}}
    {{- range $resources }}
    {{- $relPath := strings.TrimPrefix "/" .RelPermalink -}}
    {{- $imgUrl := cond (eq $relPath "") $baseURL (printf "%s/%s" $baseURL $relPath) -}}
    <image:image>
      <image:loc>{{ $imgUrl }}</image:loc>
      {{- with .Title }}<image:title>{{ . }}</image:title>{{ end }}
    </image:image>
    {{- end }}
    {{- /* Add images from front matter */ -}}
    {{- with .Params.images -}}
    {{- range . }}
    <image:image>
      <image:loc>{{ if hasPrefix . "http" }}{{ . }}{{ else }}{{ . | absURL }}{{ end }}</image:loc>
    </image:image>
    {{- end }}
    {{- end }}

  </url>
  {{- end }}

  {{- /* Include all regular pages */ -}}
  {{- range .RegularPages }}
  {{- $relPath := strings.TrimPrefix "/" .RelPermalink -}}
  {{- $url := cond (eq $relPath "") $baseURL (printf "%s/%s" $baseURL $relPath) -}}
  <url>
    <loc>{{ $url }}</loc>

    {{- with .Lastmod }}
    <lastmod>{{ .Format "2006-01-02T15:04:05-07:00" }}</lastmod>
    {{- end }}

    {{- /* Add images from markdown front matter + page bundles */ -}}
    {{- $resources := .Resources.ByType "image" -}}
    {{- range $resources }}
    {{- $relPath := strings.TrimPrefix "/" .RelPermalink -}}
    {{- $imgUrl := cond (eq $relPath "") $baseURL (printf "%s/%s" $baseURL $relPath) -}}
    <image:image>
      <image:loc>{{ $imgUrl }}</image:loc>
      {{- with .Title }}<image:title>{{ . }}</image:title>{{ end }}
    </image:image>
    {{- end }}
    {{- /* Add images from front matter */ -}}
    {{- with .Params.images -}}
    {{- range . }}
    <image:image>
      <image:loc>{{ if hasPrefix . "http" }}{{ . }}{{ else }}{{ . | absURL }}{{ end }}</image:loc>
    </image:image>
    {{- end }}
    {{- end }}

  </url>
  {{- end }}
{{- end }}

</urlset>
